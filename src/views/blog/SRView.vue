<template>
  <div class="sr-page">
    <section class="page-hero bg-light py-5" style="margin-top: 90px;">
      <div class="container">
        <div class="row justify-content-center text-center">
          <div class="col-md-8">
            <h1 class="display-4 text-uppercase mb-4">JADE - ä¼æ¥­ç¤¾æœƒè²¬ä»»å®£è¨€</h1>
          </div>
        </div>
      </div>
    </section>

    <section class="sr-intro section-padding">
      <div class="container">
        <div class="row">
          <div class="col-lg-12">
            <div class="sr-content">
              <p>JADE ä¸åƒ…æ˜¯ä¸€å€‹æœé£¾é›»å•†å¹³å°ï¼Œæ›´æ˜¯ä¸€å€‹æ‰¿è¼‰ç¤¾æœƒè²¬ä»»çš„ä¼æ¥­ã€‚æˆ‘å€‘æ·±ä¿¡ï¼Œç§‘æŠ€èˆ‡å•†æ¥­çš„ç™¼å±•æ‡‰è©²èˆ‡ç¤¾æœƒç¦ç¥‰ã€ç’°å¢ƒä¿è­·å’Œå¯æŒçºŒç™¼å±•æ”œæ‰‹ä¸¦é€²ã€‚ä½œç‚ºæ–°ä¸€ä»£çš„é›»å•†å¹³å°ï¼Œæˆ‘å€‘è‡´åŠ›æ–¼å‰µé€ ä¸€å€‹æ›´å…¬å¹³ã€æ›´åŒ…å®¹ã€æ›´æ°¸çºŒçš„æ™‚å°šç”Ÿæ…‹ç³»çµ±ã€‚</p>
              <p>ğŸ¤ æ”¯æŒä¸­å°å‹ä¼æ¥­èˆ‡å‰µæ¥­è€…é™ä½å‰µæ¥­é–€æª»ï¼Œå¯¦ç¾å¤¢æƒ³ã€‚æˆ‘å€‘ç›¸ä¿¡æ¯å€‹æœ‰æ‰è¯çš„è¨­è¨ˆå¸«å’Œå‰µæ¥­è€…éƒ½æ‡‰è©²æœ‰å±•ç¤ºä½œå“çš„æ©Ÿæœƒã€‚JADE å¹³å°å°ˆé–€ç‚ºä¸­å°å‹æœé£¾è³£å®¶è¨­è¨ˆäº†å‹å–„çš„å…¥é§æ©Ÿåˆ¶ï¼š</p>
<p>ç°¡åŒ–ç”³è«‹æµç¨‹ï¼šæä¾›æ¸…æ™°çš„è³£å®¶ç”³è«‹æŒ‡å¼•ï¼Œé™ä½æŠ€è¡“èˆ‡è³‡é‡‘é–€æª»</p>
<p>å®Œæ•´ç®¡ç†å·¥å…·ï¼šå…è²»æä¾›å•†å“ç®¡ç†ã€åº«å­˜æ§åˆ¶ã€è²¡å‹™ç®¡ç†ç­‰å°ˆæ¥­å·¥å…·</p>
<p>æ™ºèƒ½é€šçŸ¥ç³»çµ±ï¼šè‡ªå‹•åŒ–åº«å­˜è£œè²¨æé†’ï¼Œå”åŠ©è³£å®¶å„ªåŒ–ç‡Ÿé‹æ•ˆç‡</p>
<p>å…¬å¹³å¯©æ ¸åˆ¶åº¦ï¼šå»ºç«‹é€æ˜çš„è³£å®¶å¯©æ ¸æ©Ÿåˆ¶ï¼Œç¢ºä¿å¹³ç­‰ç«¶çˆ­ç’°å¢ƒ</p>
<p>æ‰¶æ¤å°ç£åœ¨åœ°å“ç‰Œï¼šæˆ‘å€‘ç‰¹åˆ¥é‡è¦–å°ç£æœ¬åœŸè¨­è¨ˆå¸«èˆ‡å“ç‰Œçš„ç™¼å±•ï¼Œé€éå¹³å°è³‡æºå”åŠ©ä»–å€‘æ¥è§¸æ›´å»£å¤§çš„æ¶ˆè²»ç¾¤é«”ï¼Œè®“å°ç£çš„å‰µæ„èˆ‡è¨­è¨ˆèƒ½åœ¨åœ‹éš›èˆå°ä¸Šç™¼å…‰ç™¼ç†±ã€‚</p>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ç¤¾æœƒè²¬ä»»ç›¸é—œæ–‡ç« åˆ—è¡¨ -->
    <section class="sr-posts section-padding">
      <div class="container">
        <div class="row">
          <div class="col-lg-12">
            <div class="section-tittle mb-40">
              <h2>ç›¸é—œæ–‡ç« </h2>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-lg-12">
            <div v-if="loading" class="text-center">
              <p>è¼‰å…¥ä¸­...</p>
            </div>
            <div v-else-if="posts.length > 0">
              <div 
                v-for="post in posts" 
                :key="post.Id" 
                class="single-post"
                :class="{ 'highlighted': highlightedPostId == post.Id }"
                @click="viewPost(post)"
              >
                <div class="post-thumb" v-if="post.CoverImage || post.coverImage">
                  <img :src="getImageUrl(post.CoverImage || post.coverImage)" :alt="post.Title || post.title">
                </div>
                <div class="post-content">
                  <h3>{{ post.Title || post.title }}</h3>
                  <p>{{ post.Excerpt || post.excerpt || getExcerpt(post.Content || post.content) }}</p>
                  <span class="post-date">{{ formatDate(post.PublishedAt || post.publishedAt || post.Created_At || post.createdAt) }}</span>
                  <span class="category-tag">{{ post.Category || post.category }}</span>
                </div>
              </div>
            </div>
            <div v-else class="no-posts">
              <p>ç›®å‰é‚„æ²’æœ‰ç›¸é—œæ–‡ç« </p>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- æ–‡ç« è©³æƒ…å½ˆçª— -->
    <div v-if="selectedPost" class="post-modal" @click="closeModal">
      <div class="modal-content" @click.stop>
        <div class="modal-header">
          <h3>{{ selectedPost.Title || selectedPost.title }}</h3>
          <button @click="closeModal" class="close-btn">&times;</button>
        </div>
        <div class="modal-body">
          <div v-if="selectedPost.CoverImage || selectedPost.coverImage" class="post-image">
            <img :src="getImageUrl(selectedPost.CoverImage || selectedPost.coverImage)" :alt="selectedPost.Title || selectedPost.title">
          </div>
          <div class="post-meta">
            <span class="post-date">{{ formatDate(selectedPost.PublishedAt || selectedPost.publishedAt || selectedPost.Created_At || selectedPost.createdAt) }}</span>
            <span class="category-tag">{{ selectedPost.Category || selectedPost.category }}</span>
          </div>
          <div class="post-content" v-html="selectedPost.Content || selectedPost.content"></div>
        </div>
      </div>
    </div>
  </div>
</template>

<script>
import { ref, onMounted } from 'vue'

export default {
  name: 'SRView',
  data() {
    return {
      posts: [],
      loading: true,
      selectedPost: null,
      highlightedPostId: null
    }
  },
  async created() {
    // æª¢æŸ¥æ˜¯å¦æœ‰è¦é«˜äº®çš„æ–‡ç«  ID
    if (this.$route.query.highlight) {
      this.highlightedPostId = parseInt(this.$route.query.highlight);
    }
    
    await this.fetchSRPosts();
  },
  methods: {
    async fetchSRPosts() {
      try {
        this.loading = true;
        console.log('ğŸ” é–‹å§‹è¼‰å…¥ç¤¾æœƒè²¬ä»»æ–‡ç« ...');
        
        // å˜—è©¦ä¸åŒçš„ API ç«¯é»
        let response;
        let posts = [];
        
        try {
          // æ–¹æ³•1: ä½¿ç”¨æŸ¥è©¢åƒæ•¸
          console.log('ğŸ“¡ å˜—è©¦ä½¿ç”¨æŸ¥è©¢åƒæ•¸æ–¹å¼...');
          response = await fetch('/api/OfficialPosts?category=ç¤¾æœƒè²¬ä»»', {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json'
            }
          });
          
          if (response.ok) {
            const text = await response.text();
            console.log('ğŸ“ API å›æ‡‰ (æŸ¥è©¢åƒæ•¸):', text);
            
            const data = text ? JSON.parse(text) : [];
            
            // è™•ç†ä¸åŒçš„å›æ‡‰æ ¼å¼
            if (Array.isArray(data)) {
              posts = data;
            } else if (data.Data && Array.isArray(data.Data)) {
              posts = data.Data;
            } else if (data.data && Array.isArray(data.data)) {
              posts = data.data;
            }
            
            console.log('ğŸ“Š æ‰¾åˆ°ç¤¾æœƒè²¬ä»»æ–‡ç« :', posts.length, 'ç¯‡');
          }
        } catch (error) {
          console.warn('æŸ¥è©¢åƒæ•¸æ–¹å¼å¤±æ•—:', error);
        }
        
        // å¦‚æœç¬¬ä¸€ç¨®æ–¹æ³•æ²’æ‰¾åˆ°æ–‡ç« ï¼Œå˜—è©¦ç¬¬äºŒç¨®æ–¹æ³•
        if (posts.length === 0) {
          try {
            console.log('ğŸ“¡ å˜—è©¦ä½¿ç”¨åˆ†é¡è·¯ç”±æ–¹å¼...');
            response = await fetch('/api/OfficialPosts/by-category/ç¤¾æœƒè²¬ä»»', {
              method: 'GET',
              headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
              }
            });
            
            if (response.ok) {
              const text = await response.text();
              console.log('ğŸ“ API å›æ‡‰ (åˆ†é¡è·¯ç”±):', text);
              
              const data = text ? JSON.parse(text) : [];
              
              if (Array.isArray(data)) {
                posts = data;
              } else if (data.Data && Array.isArray(data.Data)) {
                posts = data.Data;
              } else if (data.data && Array.isArray(data.data)) {
                posts = data.data;
              }
              
              console.log('ğŸ“Š æ‰¾åˆ°ç¤¾æœƒè²¬ä»»æ–‡ç« :', posts.length, 'ç¯‡');
            }
          } catch (error) {
            console.warn('åˆ†é¡è·¯ç”±æ–¹å¼å¤±æ•—:', error);
          }
        }
        
        // å¦‚æœé‚„æ˜¯æ²’æœ‰æ–‡ç« ï¼Œç²å–æ‰€æœ‰æ–‡ç« ç„¶å¾Œéæ¿¾
        if (posts.length === 0) {
          console.log('ğŸ“¡ å˜—è©¦ç²å–æ‰€æœ‰æ–‡ç« ç„¶å¾Œéæ¿¾...');
          
          try {
            response = await fetch('/api/OfficialPosts', {
              method: 'GET',
              headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
              }
            });
            
            if (response.ok) {
              const text = await response.text();
              const data = text ? JSON.parse(text) : [];
              
              let allPosts = [];
              if (Array.isArray(data)) {
                allPosts = data;
              } else if (data.Data && Array.isArray(data.Data)) {
                allPosts = data.Data;
              } else if (data.data && Array.isArray(data.data)) {
                allPosts = data.data;
              }
              
              console.log('ğŸ“Š æ‰€æœ‰æ–‡ç« æ•¸é‡:', allPosts.length);
              
              // éæ¿¾ç¤¾æœƒè²¬ä»»æ–‡ç« 
              posts = allPosts.filter(post => {
                const category = post.Category || post.category || '';
                const isSR = category === 'ç¤¾æœƒè²¬ä»»';
                if (isSR) {
                  console.log('âœ… æ‰¾åˆ°ç¤¾æœƒè²¬ä»»æ–‡ç« :', post.Title || post.title);
                }
                return isSR;
              });
              
              console.log('ğŸ“Š éæ¿¾å¾Œçš„ç¤¾æœƒè²¬ä»»æ–‡ç« :', posts.length, 'ç¯‡');
            }
          } catch (error) {
            console.error('ç²å–æ‰€æœ‰æ–‡ç« å¤±æ•—:', error);
          }
        }
        
        // å¦‚æœé‚„æ˜¯æ²’æœ‰ï¼Œå‰µå»ºæ¸¬è©¦æ•¸æ“š
        if (posts.length === 0) {
          console.log('âš ï¸ æ²’æœ‰æ‰¾åˆ°ç¤¾æœƒè²¬ä»»æ–‡ç« ï¼Œä½¿ç”¨æ¸¬è©¦æ•¸æ“š');
          posts = [
            {
              Id: 999,
              Title: "JADE ä¼æ¥­ç¤¾æœƒè²¬ä»»å¯¦è¸",
              Content: "ä½œç‚ºä¸€å€‹è² è²¬ä»»çš„ä¼æ¥­ï¼ŒJADE è‡´åŠ›æ–¼å‰µé€ æ›´ç¾å¥½çš„ç¤¾æœƒç’°å¢ƒ...",
              Category: "ç¤¾æœƒè²¬ä»»",
              PublishedAt: new Date().toISOString(),
              Status: "published",
              CoverImage: "/images/banner-image-1.jpg",
              Excerpt: "äº†è§£ JADE å¦‚ä½•å¯¦è¸ä¼æ¥­ç¤¾æœƒè²¬ä»»ï¼Œå‰µé€ æ›´ç¾å¥½çš„æœªä¾†ã€‚"
            },
            {
              Id: 998,
              Title: "å¯æŒçºŒæ™‚å°šçš„æœªä¾†",
              Content: "æ¢è¨æ™‚å°šç”¢æ¥­å¦‚ä½•å¯¦ç¾å¯æŒçºŒç™¼å±•ï¼Œä¿è­·æˆ‘å€‘çš„åœ°çƒ...",
              Category: "ç¤¾æœƒè²¬ä»»",
              PublishedAt: new Date(Date.now() - 86400000).toISOString(),
              Status: "published",
              CoverImage: "/images/banner-image-2.jpg",
              Excerpt: "æ™‚å°šèˆ‡ç’°ä¿ä¸¦éå°ç«‹ï¼Œè®“æˆ‘å€‘ä¸€èµ·å‰µé€ å¯æŒçºŒçš„æ™‚å°šæœªä¾†ã€‚"
            }
          ];
        }
        
        this.posts = posts;
        
        // å¦‚æœæœ‰é«˜äº®æ–‡ç« ä¸”ä¸åœ¨ç•¶å‰åˆ—è¡¨ä¸­ï¼Œå–®ç¨ç²å–
        if (this.highlightedPostId && !this.posts.find(p => (p.Id || p.id) === this.highlightedPostId)) {
          await this.fetchHighlightedPost();
        }
        
        console.log('âœ… ç¤¾æœƒè²¬ä»»æ–‡ç« è¼‰å…¥å®Œæˆ:', this.posts.length, 'ç¯‡');
        
      } catch (error) {
        console.error('âŒ è¼‰å…¥ç¤¾æœƒè²¬ä»»æ–‡ç« å¤±æ•—:', error);
        this.posts = [];
      } finally {
        this.loading = false;
      }
    },
    
    async fetchHighlightedPost() {
      try {
        console.log('ğŸ” å˜—è©¦ç²å–é«˜äº®æ–‡ç« :', this.highlightedPostId);
        
        const response = await fetch(`/api/OfficialPosts/${this.highlightedPostId}`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          }
        });
        
        if (response.ok) {
          const text = await response.text();
          const post = text ? JSON.parse(text) : null;
          
          console.log('ğŸ“ é«˜äº®æ–‡ç« å›æ‡‰:', post);
          
          if (post && (post.Category === 'ç¤¾æœƒè²¬ä»»' || post.category === 'ç¤¾æœƒè²¬ä»»')) {
            // å°‡é«˜äº®æ–‡ç« æ’å…¥åˆ°åˆ—è¡¨å‰é¢
            this.posts.unshift(post);
            console.log('âœ… é«˜äº®æ–‡ç« å·²åŠ å…¥åˆ—è¡¨');
          }
        }
      } catch (error) {
        console.error('âŒ ç²å–é«˜äº®æ–‡ç« å¤±æ•—:', error);
      }
    },
    
    viewPost(post) {
      this.selectedPost = post;
      // ç§»é™¤é«˜äº®æ•ˆæœ
      this.highlightedPostId = null;
    },
    
    closeModal() {
      this.selectedPost = null;
    },
    
    formatDate(date) {
      if (!date) return '';
      return new Date(date).toLocaleDateString('zh-TW', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
    },
    
    getImageUrl(imagePath) {
      if (!imagePath) return '/images/post/default.jpg';
      // æ ¹æ“šä½ çš„å¾Œç«¯è¨­å®šèª¿æ•´è·¯å¾‘
      if (imagePath.startsWith('http')) {
        return imagePath;
      }
      // å˜—è©¦ä¸åŒçš„è·¯å¾‘æ ¼å¼
      if (imagePath.startsWith('/')) {
        return imagePath;
      }
      return `/images/${imagePath}`;
    },
    
    getExcerpt(content, length = 150) {
      if (!content) return '';
      const textContent = content.replace(/<[^>]*>/g, ''); // ç§»é™¤ HTML æ¨™ç±¤
      return textContent.length > length 
        ? textContent.substring(0, length) + '...'
        : textContent;
    }
  }
}
</script>

<style scoped>
.sr-page {
  padding: 20px 0;
}

.sr-intro {
  background-color: #f8f9fa;
}

.section-padding {
  padding: 50px 0;
}

.section-tittle h2 {
  font-size: 36px;
  margin-bottom: 20px;
  color: #222222;
}

.sr-content {
  font-size: 16px;
  line-height: 1.8;
  color: #666666;
  white-space: pre-line;
}

.single-post {
  margin-bottom: 30px;
  padding: 20px;
  border: 1px solid #eee;
  border-radius: 8px;
  transition: all 0.3s ease;
  cursor: pointer;
}

.single-post:hover {
  box-shadow: 0 5px 15px rgba(0,0,0,0.1);
  transform: translateY(-2px);
}

.single-post.highlighted {
  border-color: #eb5757;
  background-color: #f8f9ff;
  box-shadow: 0 0 15px rgba(0,123,255,0.2);
}

.post-thumb img {
  width: 100%;
  height: 200px;
  object-fit: cover;
  border-radius: 4px;
}

.post-content {
  padding: 15px 0;
}

.post-content h3 {
  font-size: 20px;
  margin-bottom: 10px;
  color: #222222;
}

.post-date {
  color: #888888;
  font-size: 14px;
  margin-right: 15px;
}

.category-tag {
  background-color: #022c5c;
  color: white;
  padding: 2px 8px;
  border-radius: 12px;
  font-size: 12px;
}

.no-posts {
  text-align: center;
  padding: 40px 0;
  color: #666666;
}

/* å½ˆçª—æ¨£å¼ */
.post-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.8);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}

.modal-content {
  background: white;
  border-radius: 8px;
  max-width: 800px;
  max-height: 90vh;
  width: 90%;
  overflow-y: auto;
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px;
  border-bottom: 1px solid #eee;
}

.modal-header h3 {
  margin: 0;
  color: #222222;
}

.close-btn {
  background: none;
  border: none;
  font-size: 24px;
  cursor: pointer;
  color: #666;
}

.modal-body {
  padding: 20px;
}

.post-image img {
  width: 100%;
  height: 300px;
  object-fit: cover;
  border-radius: 4px;
  margin-bottom: 20px;
}

.post-meta {
  margin-bottom: 20px;
  padding-bottom: 10px;
  border-bottom: 1px solid #eee;
}

.post-content {
  line-height: 1.8;
  color: #444;
}

.post-content h1, .post-content h2, .post-content h3 {
  color: #222;
  margin-top: 20px;
  margin-bottom: 10px;
}

.post-content p {
  margin-bottom: 15px;
}
</style>