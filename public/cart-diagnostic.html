<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JADE è³¼ç‰©è»Šå•é¡Œè¨ºæ–·å ±å‘Š</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .status-pass { color: #28a745; }
        .status-fail { color: #dc3545; }
        .status-warning { color: #ffc107; }
        .code-block { background: #f8f9fa; padding: 1rem; border-radius: 0.25rem; margin: 0.5rem 0; }
        .test-result { margin: 1rem 0; padding: 1rem; border-radius: 0.5rem; }
        .test-pass { background: #d4edda; border: 1px solid #c3e6cb; }
        .test-fail { background: #f8d7da; border: 1px solid #f5c6cb; }
        .test-warning { background: #fff3cd; border: 1px solid #ffeaa7; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="mb-4">ğŸ›’ JADE è³¼ç‰©è»Šå•é¡Œè¨ºæ–·å ±å‘Š</h1>
        
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h3>ğŸ“Š ç³»çµ±ç‹€æ…‹æª¢æŸ¥</h3>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-primary mb-3" onclick="runAllTests()">ğŸ” é–‹å§‹å…¨é¢æª¢æŸ¥</button>
                        <div id="testResults"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h4>ğŸ” ç™»å…¥ç‹€æ…‹æª¢æŸ¥</h4>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-info" onclick="checkLoginStatus()">æª¢æŸ¥ç™»å…¥ç‹€æ…‹</button>
                        <div id="loginStatus" class="mt-3"></div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h4>ğŸŒ API é€£æ¥æ¸¬è©¦</h4>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-success" onclick="testApiConnection()">æ¸¬è©¦ API é€£æ¥</button>
                        <div id="apiStatus" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h4>ğŸ›’ è³¼ç‰©è»ŠåŠŸèƒ½æ¸¬è©¦</h4>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-warning" onclick="testCartFunctionality()">æ¸¬è©¦è³¼ç‰©è»ŠåŠŸèƒ½</button>
                        <div id="cartStatus" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h4>ğŸ“ ä¿®å¾©å»ºè­°</h4>
                    </div>
                    <div class="card-body" id="suggestions">
                        <p>é»æ“Šä¸Šæ–¹æ¸¬è©¦æŒ‰éˆ•é–‹å§‹è¨ºæ–·...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        const API_BASE_URL = 'https://jadeapi-production.up.railway.app';
        
        function log(message, type = 'info') {
            console.log(`[CART-DIAGNOSTIC] ${message}`);
        }

        function addTestResult(title, status, message, suggestions = []) {
            const resultsDiv = document.getElementById('testResults');
            const statusClass = status === 'pass' ? 'test-pass' : status === 'fail' ? 'test-fail' : 'test-warning';
            const statusIcon = status === 'pass' ? 'âœ…' : status === 'fail' ? 'âŒ' : 'âš ï¸';
            
            const resultHtml = `
                <div class="test-result ${statusClass}">
                    <h5>${statusIcon} ${title}</h5>
                    <p>${message}</p>
                    ${suggestions.length > 0 ? `
                        <div class="mt-2">
                            <strong>å»ºè­°ï¼š</strong>
                            <ul>
                                ${suggestions.map(s => `<li>${s}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                </div>
            `;
            
            resultsDiv.innerHTML += resultHtml;
        }

        function checkLoginStatus() {
            const loginDiv = document.getElementById('loginStatus');
            
            // æª¢æŸ¥ localStorage ä¸­çš„ç™»å…¥è³‡æ–™
            const memberId = localStorage.getItem('memberId');
            const authToken = localStorage.getItem('authToken') || localStorage.getItem('token');
            const currentUser = localStorage.getItem('currentUser');
            
            let statusHtml = '<h6>LocalStorage æª¢æŸ¥ï¼š</h6>';
            statusHtml += `<p><strong>æœƒå“¡ ID:</strong> ${memberId || 'âŒ æœªæ‰¾åˆ°'}</p>`;
            statusHtml += `<p><strong>èªè­‰ Token:</strong> ${authToken ? 'âœ… å·²è¨­å®š' : 'âŒ æœªæ‰¾åˆ°'}</p>`;
            statusHtml += `<p><strong>ç”¨æˆ¶è³‡æ–™:</strong> ${currentUser ? 'âœ… å·²è¨­å®š' : 'âŒ æœªæ‰¾åˆ°'}</p>`;
            
            if (currentUser) {
                try {
                    const user = JSON.parse(currentUser);
                    statusHtml += `<div class="code-block"><strong>ç”¨æˆ¶è³‡æ–™:</strong><br><pre>${JSON.stringify(user, null, 2)}</pre></div>`;
                } catch (e) {
                    statusHtml += `<p class="status-fail">ç”¨æˆ¶è³‡æ–™æ ¼å¼éŒ¯èª¤</p>`;
                }
            }
            
            loginDiv.innerHTML = statusHtml;
            
            // å›å‚³ç™»å…¥ç‹€æ…‹ä¾›å…¶ä»–å‡½å¼ä½¿ç”¨
            return {
                isLoggedIn: !!memberId && !!authToken,
                memberId,
                authToken,
                currentUser
            };
        }

        async function testApiConnection() {
            const apiDiv = document.getElementById('apiStatus');
            apiDiv.innerHTML = '<p>ğŸ”„ æ¸¬è©¦ä¸­...</p>';
            
            try {
                // æ¸¬è©¦åŸºæœ¬ API é€£æ¥
                const response = await axios.get(`${API_BASE_URL}/api/health`, {
                    timeout: 10000
                });
                
                apiDiv.innerHTML = `
                    <div class="alert alert-success">
                        <h6>âœ… API é€£æ¥æˆåŠŸ</h6>
                        <p><strong>ç‹€æ…‹ç¢¼:</strong> ${response.status}</p>
                        <p><strong>API URL:</strong> ${API_BASE_URL}</p>
                    </div>
                `;
                
                return true;
            } catch (error) {
                apiDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <h6>âŒ API é€£æ¥å¤±æ•—</h6>
                        <p><strong>éŒ¯èª¤:</strong> ${error.message}</p>
                        <p><strong>API URL:</strong> ${API_BASE_URL}</p>
                    </div>
                `;
                
                return false;
            }
        }

        async function testCartFunctionality() {
            const cartDiv = document.getElementById('cartStatus');
            cartDiv.innerHTML = '<p>ğŸ”„ æ¸¬è©¦è³¼ç‰©è»ŠåŠŸèƒ½...</p>';
            
            // é¦–å…ˆæª¢æŸ¥ç™»å…¥ç‹€æ…‹
            const loginStatus = checkLoginStatus();
            
            if (!loginStatus.isLoggedIn) {
                cartDiv.innerHTML = `
                    <div class="alert alert-warning">
                        <h6>âš ï¸ ç„¡æ³•æ¸¬è©¦è³¼ç‰©è»Š</h6>
                        <p>éœ€è¦å…ˆç™»å…¥æ‰èƒ½æ¸¬è©¦è³¼ç‰©è»ŠåŠŸèƒ½</p>
                    </div>
                `;
                return false;
            }
            
            try {
                // æ¸¬è©¦è³¼ç‰©è»Š API
                const cartUrl = `${API_BASE_URL}/api/Carts/user/${loginStatus.memberId}`;
                log(`Testing cart API: ${cartUrl}`);
                
                const response = await axios.get(cartUrl, {
                    headers: loginStatus.authToken ? {
                        'Authorization': `Bearer ${loginStatus.authToken}`
                    } : {},
                    timeout: 10000
                });
                
                cartDiv.innerHTML = `
                    <div class="alert alert-success">
                        <h6>âœ… è³¼ç‰©è»Š API æ­£å¸¸</h6>
                        <p><strong>ç‹€æ…‹ç¢¼:</strong> ${response.status}</p>
                        <p><strong>è³¼ç‰©è»Šé …ç›®æ•¸é‡:</strong> ${response.data?.length || 0}</p>
                        <div class="code-block">
                            <strong>å›æ‡‰è³‡æ–™:</strong><br>
                            <pre>${JSON.stringify(response.data, null, 2)}</pre>
                        </div>
                    </div>
                `;
                
                return true;
            } catch (error) {
                cartDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <h6>âŒ è³¼ç‰©è»Š API å¤±æ•—</h6>
                        <p><strong>éŒ¯èª¤:</strong> ${error.message}</p>
                        <p><strong>ç‹€æ…‹ç¢¼:</strong> ${error.response?.status || 'N/A'}</p>
                        ${error.response?.data ? `
                            <div class="code-block">
                                <strong>éŒ¯èª¤è©³æƒ…:</strong><br>
                                <pre>${JSON.stringify(error.response.data, null, 2)}</pre>
                            </div>
                        ` : ''}
                    </div>
                `;
                
                return false;
            }
        }

        async function runAllTests() {
            const resultsDiv = document.getElementById('testResults');
            resultsDiv.innerHTML = '<h5>ğŸ”„ åŸ·è¡Œå…¨é¢æª¢æŸ¥...</h5>';
            
            // æ¸¬è©¦ 1: ç’°å¢ƒæª¢æŸ¥
            const currentUrl = window.location.href;
            const isProduction = currentUrl.includes('netlify.app');
            addTestResult(
                'ç’°å¢ƒæª¢æŸ¥',
                'pass',
                `ç•¶å‰ç’°å¢ƒ: ${isProduction ? 'ç”Ÿç”¢ç’°å¢ƒ (Netlify)' : 'æœ¬åœ°ç’°å¢ƒ'}<br>
                 URL: ${currentUrl}<br>
                 API åŸºç¤ URL: ${API_BASE_URL}`
            );
            
            // æ¸¬è©¦ 2: ç™»å…¥ç‹€æ…‹
            const loginStatus = checkLoginStatus();
            addTestResult(
                'ç™»å…¥ç‹€æ…‹æª¢æŸ¥',
                loginStatus.isLoggedIn ? 'pass' : 'fail',
                loginStatus.isLoggedIn ? 
                    `ç”¨æˆ¶å·²ç™»å…¥ (æœƒå“¡ ID: ${loginStatus.memberId})` : 
                    'ç”¨æˆ¶æœªç™»å…¥',
                loginStatus.isLoggedIn ? [] : [
                    'è«‹å…ˆç™»å…¥ç³»çµ±',
                    'æª¢æŸ¥ localStorage æ˜¯å¦åŒ…å«æœ‰æ•ˆçš„èªè­‰è³‡æ–™'
                ]
            );
            
            // æ¸¬è©¦ 3: API é€£æ¥
            const apiResult = await testApiConnection();
            addTestResult(
                'API é€£æ¥æ¸¬è©¦',
                apiResult ? 'pass' : 'fail',
                apiResult ? 
                    'API æœå‹™å™¨å›æ‡‰æ­£å¸¸' : 
                    'API æœå‹™å™¨ç„¡æ³•é€£æ¥',
                apiResult ? [] : [
                    'æª¢æŸ¥ç¶²è·¯é€£æ¥',
                    'æª¢æŸ¥ Railway API æœå‹™ç‹€æ…‹',
                    'æª¢æŸ¥ CORS è¨­å®š'
                ]
            );
            
            // æ¸¬è©¦ 4: è³¼ç‰©è»ŠåŠŸèƒ½ (åªæœ‰åœ¨æœ‰ç™»å…¥çš„æƒ…æ³ä¸‹)
            if (loginStatus.isLoggedIn) {
                const cartResult = await testCartFunctionality();
                addTestResult(
                    'è³¼ç‰©è»ŠåŠŸèƒ½æ¸¬è©¦',
                    cartResult ? 'pass' : 'fail',
                    cartResult ? 
                        'è³¼ç‰©è»Š API å›æ‡‰æ­£å¸¸' : 
                        'è³¼ç‰©è»Š API ç„¡æ³•æ­£å¸¸å·¥ä½œ',
                    cartResult ? [] : [
                        'æª¢æŸ¥èªè­‰ token æ˜¯å¦æœ‰æ•ˆ',
                        'æª¢æŸ¥æœƒå“¡ ID æ˜¯å¦æ­£ç¢º',
                        'æª¢æŸ¥å¾Œç«¯è³¼ç‰©è»Š API ç«¯é»'
                    ]
                );
            }
            
            // ç”Ÿæˆç¸½çµå»ºè­°
            generateSuggestions(loginStatus.isLoggedIn, apiResult);
        }

        function generateSuggestions(isLoggedIn, apiConnected) {
            const suggestionsDiv = document.getElementById('suggestions');
            
            let suggestions = '<h5>ğŸ”§ ä¿®å¾©å»ºè­°ï¼š</h5>';
            
            if (!isLoggedIn) {
                suggestions += `
                    <div class="alert alert-warning">
                        <h6>â— ç™»å…¥å•é¡Œ</h6>
                        <ul>
                            <li>è«‹ç¢ºä¿ç”¨æˆ¶å·²æ­£ç¢ºç™»å…¥ç³»çµ±</li>
                            <li>æª¢æŸ¥ localStorage ä¸­çš„ memberId å’Œ authToken</li>
                            <li>å¦‚æœç™»å…¥é é¢æœ‰å•é¡Œï¼Œè«‹æª¢æŸ¥èªè­‰æµç¨‹</li>
                        </ul>
                    </div>
                `;
            }
            
            if (!apiConnected) {
                suggestions += `
                    <div class="alert alert-danger">
                        <h6>ğŸŒ API é€£æ¥å•é¡Œ</h6>
                        <ul>
                            <li>æª¢æŸ¥ Railway API æœå‹™æ˜¯å¦æ­£å¸¸é‹è¡Œ</li>
                            <li>ç¢ºèª Netlify çš„ä»£ç†è¨­å®šæ­£ç¢º</li>
                            <li>æª¢æŸ¥æ˜¯å¦æœ‰ CORS ç›¸é—œéŒ¯èª¤</li>
                            <li>ç¢ºèª API URL é…ç½®æ­£ç¢º</li>
                        </ul>
                    </div>
                `;
            }
            
            if (isLoggedIn && apiConnected) {
                suggestions += `
                    <div class="alert alert-success">
                        <h6>âœ… ç³»çµ±ç‹€æ…‹è‰¯å¥½</h6>
                        <p>ç™»å…¥ç‹€æ…‹å’Œ API é€£æ¥éƒ½æ­£å¸¸ï¼Œè³¼ç‰©è»Šæ‡‰è©²å¯ä»¥æ­£å¸¸å·¥ä½œã€‚</p>
                        <p>å¦‚æœä»æœ‰å•é¡Œï¼Œè«‹ï¼š</p>
                        <ul>
                            <li>æ¸…é™¤ç€è¦½å™¨å¿«å–</li>
                            <li>æª¢æŸ¥ç€è¦½å™¨æ§åˆ¶å°æ˜¯å¦æœ‰å…¶ä»–éŒ¯èª¤</li>
                            <li>ç¢ºèªè³¼ç‰©è»Šè³‡æ–™æ ¼å¼æ­£ç¢º</li>
                        </ul>
                    </div>
                `;
            }
            
            suggestionsDiv.innerHTML = suggestions;
        }

        // é é¢è¼‰å…¥æ™‚è‡ªå‹•åŸ·è¡ŒåŸºæœ¬æª¢æŸ¥
        window.addEventListener('load', function() {
            log('JADE Cart Diagnostic Tool loaded');
            checkLoginStatus();
        });
    </script>
</body>
</html>
