<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–°æœƒå“¡å‡ç´šé€²åº¦æ¸¬è©¦</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .test-card {
            border-left: 4px solid #007bff;
            margin-bottom: 1rem;
        }

        .success-card {
            border-left-color: #28a745;
        }

        .warning-card {
            border-left-color: #ffc107;
        }

        .error-card {
            border-left-color: #dc3545;
        }

        .debug-output {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 0.25rem;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>

<body>
    <div class="container mt-4">
        <h1 class="mb-4"><i class="fas fa-user-plus me-2"></i>æ–°æœƒå“¡å‡ç´šé€²åº¦æ¸¬è©¦</h1>
        <p class="text-muted">æ¸¬è©¦ä¿®æ­£å¾Œçš„æœƒå“¡è¨»å†Šå’Œå‡ç´šé€²åº¦é¡¯ç¤ºåŠŸèƒ½</p>

        <!-- æ¸¬è©¦æ§åˆ¶é¢æ¿ -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-control me-2"></i>æ¸¬è©¦æ§åˆ¶é¢æ¿</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3 mb-2">
                                <button class="btn btn-primary w-100" onclick="testNewMemberRegistration()">
                                    <i class="fas fa-user-plus me-2"></i>æ¨¡æ“¬æ–°æœƒå“¡è¨»å†Š
                                </button>
                            </div>
                            <div class="col-md-3 mb-2">
                                <button class="btn btn-success w-100" onclick="testMemberLevelProgress()">
                                    <i class="fas fa-chart-line me-2"></i>æ¸¬è©¦å‡ç´šé€²åº¦
                                </button>
                            </div>
                            <div class="col-md-3 mb-2">
                                <button class="btn btn-info w-100" onclick="testExistingMemberLogin()">
                                    <i class="fas fa-sign-in-alt me-2"></i>æ¸¬è©¦ç¾æœ‰æœƒå“¡ç™»å…¥
                                </button>
                            </div>
                            <div class="col-md-3 mb-2">
                                <button class="btn btn-warning w-100" onclick="clearAllAndReset()">
                                    <i class="fas fa-trash me-2"></i>æ¸…é™¤é‡ç½®
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ¸¬è©¦çµæœé¡¯ç¤º -->
        <div id="test-results"></div>

        <!-- å³æ™‚ç‹€æ…‹ç›£æ§ -->
        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h6><i class="fas fa-user me-2"></i>ç•¶å‰ç”¨æˆ¶ç‹€æ…‹</h6>
                    </div>
                    <div class="card-body">
                        <div id="user-status" class="debug-output">æœªè¼‰å…¥</div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h6><i class="fas fa-cog me-2"></i>ç³»çµ±ç‹€æ…‹</h6>
                    </div>
                    <div class="card-body">
                        <div id="system-status" class="debug-output">æº–å‚™å°±ç·’</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- å¿«é€Ÿé€£çµ -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h6><i class="fas fa-external-link-alt me-2"></i>å¿«é€Ÿé€£çµ</h6>
                    </div>
                    <div class="card-body">
                        <a href="/member/level" class="btn btn-outline-primary me-2" target="_blank">
                            <i class="fas fa-crown me-2"></i>æœƒå“¡ç­‰ç´šé é¢
                        </a>
                        <a href="/member-debug.html" class="btn btn-outline-secondary me-2" target="_blank">
                            <i class="fas fa-bug me-2"></i>é™¤éŒ¯å·¥å…·
                        </a>
                        <a href="/login" class="btn btn-outline-success me-2" target="_blank">
                            <i class="fas fa-sign-in-alt me-2"></i>ç™»å…¥é é¢
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let testCounter = 0;

        // é¡¯ç¤ºæ¸¬è©¦çµæœ
        function showTestResult(title, success, message, details = null) {
            const resultDiv = document.getElementById('test-results');
            const cardClass = success ? 'success-card' : 'error-card';
            const iconClass = success ? 'fas fa-check-circle text-success' : 'fas fa-times-circle text-danger';

            testCounter++;

            const resultHTML = `
                <div class="card test-card ${cardClass}">
                    <div class="card-body">
                        <h6><i class="${iconClass} me-2"></i>æ¸¬è©¦ ${testCounter}: ${title}</h6>
                        <p class="mb-2">${message}</p>
                        ${details ? `<div class="debug-output">${details}</div>` : ''}
                    </div>
                </div>
            `;

            resultDiv.innerHTML = resultHTML + resultDiv.innerHTML;
            updateUserStatus();
        }

        // æ›´æ–°ç”¨æˆ¶ç‹€æ…‹é¡¯ç¤º
        function updateUserStatus() {
            const statusDiv = document.getElementById('user-status');

            try {
                const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                const memberId = localStorage.getItem('memberId');
                const authToken = localStorage.getItem('authToken');

                const status = {
                    'ç™»å…¥ç‹€æ…‹': authToken ? 'å·²ç™»å…¥' : 'æœªç™»å…¥',
                    'ç”¨æˆ¶é¡å‹': currentUser.userType || 'ç„¡',
                    'ç”¨æˆ¶åç¨±': currentUser.username || 'ç„¡',
                    'æœƒå“¡ID': memberId || currentUser.memberId || 'ç„¡',
                    'ç”¨æˆ¶è³‡æ–™': currentUser
                };

                statusDiv.textContent = JSON.stringify(status, null, 2);
            } catch (error) {
                statusDiv.textContent = `éŒ¯èª¤: ${error.message}`;
            }
        }

        // æ¸¬è©¦æ–°æœƒå“¡è¨»å†Š
        async function testNewMemberRegistration() {
            try {
                // æ¸…é™¤ç¾æœ‰è³‡æ–™
                localStorage.clear();

                // æ¨¡æ“¬è¨»å†Šæ–°æœƒå“¡
                const newMemberData = {
                    username: `æ¸¬è©¦æœƒå“¡_${Date.now()}`,
                    email: `test${Date.now()}@example.com`,
                    userType: 'member',
                    password: '123456'
                };

                // æ¨¡æ“¬ authService çš„è¨»å†Šé‚è¼¯
                const userId = Date.now();
                const newUser = {
                    userId: userId,
                    memberId: userId, // é—œéµä¿®æ­£ï¼šè¨­å®šæœƒå“¡ID
                    username: newMemberData.username,
                    userType: 'member',
                    email: newMemberData.email,
                    membershipLevel: 'bronze',
                    totalOrders: 0,
                    totalSpent: 0,
                    joinDate: new Date().toISOString().split('T')[0]
                };

                // å„²å­˜åˆ° localStorageï¼ˆæ¨¡æ“¬ saveUserToStorageï¼‰
                localStorage.setItem('currentUser', JSON.stringify(newUser));
                localStorage.setItem('memberId', newUser.memberId.toString());
                localStorage.setItem('authToken', `token-${userId}`);

                showTestResult(
                    'æ–°æœƒå“¡è¨»å†Š',
                    true,
                    'âœ… æ–°æœƒå“¡è¨»å†ŠæˆåŠŸï¼Œå·²æ­£ç¢ºè¨­å®šæœƒå“¡ID',
                    `æœƒå“¡ID: ${newUser.memberId}\nç”¨æˆ¶å: ${newUser.username}\nç­‰ç´š: ${newUser.membershipLevel}`
                );

            } catch (error) {
                showTestResult(
                    'æ–°æœƒå“¡è¨»å†Š',
                    false,
                    `âŒ è¨»å†Šå¤±æ•—: ${error.message}`,
                    error.stack
                );
            }
        }

        // æ¸¬è©¦æœƒå“¡ç­‰ç´šé€²åº¦
        async function testMemberLevelProgress() {
            try {
                const memberId = localStorage.getItem('memberId');
                if (!memberId) {
                    throw new Error('è«‹å…ˆæ¨¡æ“¬æœƒå“¡è¨»å†Š');
                }

                // æ¨¡æ“¬ memberLevelService.getLevelSummary() çš„é è¨­å›æ‡‰
                const defaultSummary = {
                    currentLevel: {
                        id: 1,
                        name: "éŠ…å¡æœƒå“¡",
                        requiredAmount: 0,
                        description: "æ–°æœƒå“¡é è¨­ç­‰ç´š"
                    },
                    nextLevel: {
                        id: 2,
                        name: "éŠ€å¡æœƒå“¡",
                        requiredAmount: 1000,
                        description: "é€²éšæœƒå“¡ç­‰ç´š"
                    },
                    totalSpent: 0,
                    progress: {
                        percentage: 0,
                        currentAmount: 0,
                        requiredForNext: 1000,
                        isMaxLevel: false
                    }
                };

                showTestResult(
                    'å‡ç´šé€²åº¦è¼‰å…¥',
                    true,
                    'âœ… æ–°æœƒå“¡å‡ç´šé€²åº¦æ­£å¸¸é¡¯ç¤º',
                    JSON.stringify(defaultSummary, null, 2)
                );

            } catch (error) {
                showTestResult(
                    'å‡ç´šé€²åº¦è¼‰å…¥',
                    false,
                    `âŒ é€²åº¦è¼‰å…¥å¤±æ•—: ${error.message}`,
                    error.stack
                );
            }
        }

        // æ¸¬è©¦ç¾æœ‰æœƒå“¡ç™»å…¥
        async function testExistingMemberLogin() {
            try {
                // æ¨¡æ“¬ç¾æœ‰æœƒå“¡ç™»å…¥
                const existingUser = {
                    userId: 123,
                    memberId: 123,
                    username: 'è²·å®¶å°æ˜',
                    userType: 'member',
                    email: 'ming@example.com',
                    membershipLevel: 'gold',
                    totalOrders: 25,
                    totalSpent: 15000,
                    joinDate: '2024-01-15'
                };

                localStorage.setItem('currentUser', JSON.stringify(existingUser));
                localStorage.setItem('memberId', existingUser.memberId.toString());
                localStorage.setItem('authToken', 'mock-token-123');

                showTestResult(
                    'ç¾æœ‰æœƒå“¡ç™»å…¥',
                    true,
                    'âœ… ç¾æœ‰æœƒå“¡ç™»å…¥æˆåŠŸï¼Œå‡ç´šé€²åº¦æ‡‰å¯æ­£å¸¸é¡¯ç¤º',
                    `æœƒå“¡: ${existingUser.username}\nç­‰ç´š: ${existingUser.membershipLevel}\nç´¯ç©æ¶ˆè²»: ${existingUser.totalSpent}å…ƒ`
                );

            } catch (error) {
                showTestResult(
                    'ç¾æœ‰æœƒå“¡ç™»å…¥',
                    false,
                    `âŒ ç™»å…¥å¤±æ•—: ${error.message}`,
                    error.stack
                );
            }
        }

        // æ¸…é™¤ä¸¦é‡ç½®
        function clearAllAndReset() {
            localStorage.clear();
            document.getElementById('test-results').innerHTML = '';
            testCounter = 0;

            showTestResult(
                'ç³»çµ±é‡ç½®',
                true,
                'ğŸ”„ æ‰€æœ‰è³‡æ–™å·²æ¸…é™¤ï¼Œç³»çµ±å·²é‡ç½®',
                'æº–å‚™é€²è¡Œæ–°çš„æ¸¬è©¦'
            );
        }

        // æ›´æ–°ç³»çµ±ç‹€æ…‹
        function updateSystemStatus() {
            const systemDiv = document.getElementById('system-status');
            const now = new Date().toLocaleString('zh-TW');

            systemDiv.textContent = `æœ€å¾Œæ›´æ–°: ${now}\nç€è¦½å™¨: ${navigator.userAgent}`;
        }

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        window.onload = function () {
            updateUserStatus();
            updateSystemStatus();

            // æ¯ç§’æ›´æ–°ç‹€æ…‹
            setInterval(() => {
                updateUserStatus();
            }, 1000);
        };
    </script>
</body>

</html>