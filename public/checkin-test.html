<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç°½åˆ°åŠŸèƒ½æ¸¬è©¦</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.22.4/dist/sweetalert2.all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>

<body>
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0"><i class="fas fa-calendar-check me-2"></i>ç°½åˆ°åŠŸèƒ½æ¸¬è©¦</h4>
                    </div>
                    <div class="card-body">
                        <!-- æˆå“¡ ID è¼¸å…¥ -->
                        <div class="mb-3">
                            <label for="memberId" class="form-label">æ¸¬è©¦æœƒå“¡ ID:</label>
                            <input type="number" class="form-control" id="memberId" placeholder="è«‹è¼¸å…¥æœƒå“¡ ID (ä¾‹å¦‚: 11)"
                                value="11">
                        </div>

                        <!-- API åŸºç¤ URL è¨­å®š -->
                        <div class="mb-3">
                            <label for="apiBaseUrl" class="form-label">API åŸºç¤ URL:</label>
                            <input type="text" class="form-control" id="apiBaseUrl" placeholder="è«‹è¼¸å…¥ API URL"
                                value="https://localhost:7106">
                        </div>

                        <!-- é€£ç·šç‹€æ…‹ -->
                        <div class="mb-3">
                            <div class="d-flex align-items-center">
                                <span class="me-2">é€£ç·šç‹€æ…‹:</span>
                                <span id="connectionStatus" class="badge bg-secondary">æœªæ¸¬è©¦</span>
                            </div>
                        </div>

                        <!-- æ“ä½œæŒ‰éˆ• -->
                        <div class="d-grid gap-2 d-md-flex justify-content-md-start mb-4">
                            <button class="btn btn-info" onclick="testConnection()">
                                <i class="fas fa-wifi me-2"></i>æ¸¬è©¦é€£ç·š
                            </button>
                            <button class="btn btn-secondary" onclick="quickConnectionTest()">
                                <i class="fas fa-bolt me-2"></i>å¿«é€Ÿæª¢æŸ¥
                            </button>
                            <button class="btn btn-primary" onclick="getCheckinInfo()">
                                <i class="fas fa-info-circle me-2"></i>æŸ¥è©¢ç°½åˆ°ç‹€æ…‹
                            </button>
                            <button class="btn btn-success" onclick="performCheckin()">
                                <i class="fas fa-calendar-plus me-2"></i>åŸ·è¡Œç°½åˆ°
                            </button>
                        </div>

                        <!-- æ¸¬è©¦å·¥å…·æŒ‰éˆ• -->
                        <div class="d-grid gap-2 d-md-flex justify-content-md-start mb-4">
                            <button class="btn btn-warning" onclick="simulateYesterdayCheckin()">
                                <i class="fas fa-calendar-minus me-2"></i>æ¨¡æ“¬æ˜¨å¤©ç°½åˆ°
                            </button>
                            <button class="btn btn-danger" onclick="resetCheckinStatus()">
                                <i class="fas fa-trash-restore me-2"></i>é‡ç½®ç°½åˆ°ç‹€æ…‹
                            </button>
                            <button class="btn btn-info" onclick="simulateStreakCheckin()">
                                <i class="fas fa-fire me-2"></i>æ¨¡æ“¬é€£çºŒç°½åˆ°
                            </button>
                        </div>

                        <!-- çµæœé¡¯ç¤ºå€åŸŸ -->
                        <div class="accordion" id="resultsAccordion">
                            <!-- ç°½åˆ°ç‹€æ…‹æŸ¥è©¢çµæœ -->
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="statusHeading">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                        data-bs-target="#statusCollapse">
                                        <i class="fas fa-info-circle me-2"></i>ç°½åˆ°ç‹€æ…‹æŸ¥è©¢çµæœ
                                    </button>
                                </h2>
                                <div id="statusCollapse" class="accordion-collapse collapse"
                                    data-bs-parent="#resultsAccordion">
                                    <div class="accordion-body">
                                        <pre id="statusResult" class="bg-light p-3 rounded">å°šæœªæŸ¥è©¢</pre>
                                    </div>
                                </div>
                            </div>

                            <!-- ç°½åˆ°åŸ·è¡Œçµæœ -->
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="checkinHeading">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                        data-bs-target="#checkinCollapse">
                                        <i class="fas fa-calendar-check me-2"></i>ç°½åˆ°åŸ·è¡Œçµæœ
                                    </button>
                                </h2>
                                <div id="checkinCollapse" class="accordion-collapse collapse"
                                    data-bs-parent="#resultsAccordion">
                                    <div class="accordion-body">
                                        <pre id="checkinResult" class="bg-light p-3 rounded">å°šæœªåŸ·è¡Œ</pre>
                                    </div>
                                </div>
                            </div>

                            <!-- éŒ¯èª¤æ—¥èªŒ -->
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="errorHeading">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                        data-bs-target="#errorCollapse">
                                        <i class="fas fa-exclamation-triangle me-2"></i>éŒ¯èª¤æ—¥èªŒ
                                    </button>
                                </h2>
                                <div id="errorCollapse" class="accordion-collapse collapse"
                                    data-bs-parent="#resultsAccordion">
                                    <div class="accordion-body">
                                        <pre id="errorLog" class="bg-danger text-white p-3 rounded">ç„¡éŒ¯èª¤</pre>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- æ¸…é™¤çµæœ -->
                        <div class="mt-3">
                            <button class="btn btn-secondary btn-sm" onclick="clearResults()">
                                <i class="fas fa-trash me-2"></i>æ¸…é™¤çµæœ
                            </button>
                        </div>
                    </div>
                </div>

                <!-- API æ–‡æª”èªªæ˜ -->
                <div class="card mt-4">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="fas fa-book me-2"></i>API è¦æ ¼èªªæ˜</h5>
                    </div>
                    <div class="card-body">
                        <h6>æŸ¥è©¢ç°½åˆ°ç‹€æ…‹ API:</h6>
                        <code>GET /api/Members/{memberId}/Checkin/Info</code>

                        <h6 class="mt-3">åŸ·è¡Œç°½åˆ° API:</h6>
                        <code>POST /api/Members/{memberId}/Checkin</code>

                        <h6 class="mt-3">é æœŸå›æ‡‰æ ¼å¼:</h6>
                        <pre class="bg-light p-2 rounded">
// Checkin/Info å›æ‡‰
{
  "memberId": 11,
  "today": "2025-08-22",
  "signedToday": true,
  "checkinStreak": 3,
  "todayReward": 0.3,
  "serverTime": "2025-08-22T10:05:00",
  "unit": "jcoin",
  "scale": 10
}

// Checkin å›æ‡‰
{
  "memberId": 11,
  "signedToday": true,
  "checkinStreak": 4,
  "reward": 0.4,
  "beforeBalance": 18.6,
  "afterBalance": 19.0,
  "verificationCode": "CHK-20250822-11",
  "createdAt": "2025-08-22T10:06:12"
}
                        </pre>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // æ›´æ–°é€£ç·šç‹€æ…‹é¡¯ç¤º
        function updateConnectionStatus(status, className) {
            const statusElement = document.getElementById('connectionStatus');
            statusElement.textContent = status;
            statusElement.className = `badge ${className}`;
        }

        // æ¸¬è©¦ API é€£ç·š
        async function testConnection() {
            const apiBaseUrl = document.getElementById('apiBaseUrl').value.trim();

            if (!apiBaseUrl) {
                Swal.fire('éŒ¯èª¤', 'è«‹è¼¸å…¥ API åŸºç¤ URL', 'error');
                return;
            }

            updateConnectionStatus('æ¸¬è©¦ä¸­...', 'bg-warning');

            try {
                // å…ˆå˜—è©¦å¥åº·æª¢æŸ¥ç«¯é»
                const response = await axios.get(`${apiBaseUrl}/api/health`, {
                    timeout: 5000
                });

                updateConnectionStatus('å·²é€£ç·š', 'bg-success');
                Swal.fire('æˆåŠŸ', 'API é€£ç·šæ¸¬è©¦æˆåŠŸ', 'success');

            } catch (error) {
                // å¦‚æœå¥åº·æª¢æŸ¥å¤±æ•—ï¼Œå˜—è©¦ä½¿ç”¨ç°½åˆ°æŸ¥è©¢ç«¯é»æ¸¬è©¦é€£ç·š
                if (error.response?.status === 404) {
                    console.log('å¥åº·æª¢æŸ¥ç«¯é»ä¸å­˜åœ¨ï¼Œå˜—è©¦ä½¿ç”¨ç°½åˆ°ç«¯é»æ¸¬è©¦é€£ç·š...');

                    try {
                        // ä½¿ç”¨æœƒå“¡ ID 11 æ¸¬è©¦ç°½åˆ°ç«¯é»é€£ç·š
                        const testResponse = await axios.get(`${apiBaseUrl}/api/Members/11/Checkin/Info`, {
                            timeout: 5000
                        });

                        updateConnectionStatus('å·²é€£ç·š', 'bg-success');
                        Swal.fire({
                            title: 'é€£ç·šæˆåŠŸ',
                            text: 'API ä¼ºæœå™¨å¯é€£ç·šï¼ˆé€éç°½åˆ°ç«¯é»é©—è­‰ï¼‰',
                            icon: 'success'
                        });

                    } catch (checkinError) {
                        if (checkinError.response?.status >= 400 && checkinError.response?.status < 500) {
                            // 4xx éŒ¯èª¤è¡¨ç¤ºä¼ºæœå™¨æœ‰å›æ‡‰ï¼Œåªæ˜¯æ¥­å‹™é‚è¼¯å•é¡Œ
                            updateConnectionStatus('å·²é€£ç·š', 'bg-success');
                            Swal.fire({
                                title: 'é€£ç·šæˆåŠŸ',
                                text: 'API ä¼ºæœå™¨å¯é€£ç·šï¼ˆä¼ºæœå™¨æœ‰å›æ‡‰ï¼‰',
                                icon: 'info'
                            });
                        } else {
                            updateConnectionStatus('é€£ç·šå¤±æ•—', 'bg-danger');
                            logError('é€£ç·šæ¸¬è©¦å¤±æ•—', checkinError);
                            Swal.fire('éŒ¯èª¤', `é€£ç·šå¤±æ•—: ${checkinError.message}`, 'error');
                        }
                    }
                } else if (error.code === 'ECONNABORTED') {
                    updateConnectionStatus('é€£ç·šå¤±æ•—', 'bg-danger');
                    logError('é€£ç·šæ¸¬è©¦å¤±æ•—', error);
                    Swal.fire('éŒ¯èª¤', 'é€£ç·šè¶…æ™‚ï¼Œè«‹æª¢æŸ¥ API URL æ˜¯å¦æ­£ç¢º', 'error');
                } else {
                    updateConnectionStatus('é€£ç·šå¤±æ•—', 'bg-danger');
                    logError('é€£ç·šæ¸¬è©¦å¤±æ•—', error);
                    Swal.fire('éŒ¯èª¤', `é€£ç·šå¤±æ•—: ${error.message}`, 'error');
                }
            }
        }

        // å¿«é€Ÿé€£ç·šæª¢æŸ¥ - ç›´æ¥ä½¿ç”¨ç°½åˆ°ç«¯é»
        async function quickConnectionTest() {
            const apiBaseUrl = document.getElementById('apiBaseUrl').value.trim();
            const memberId = document.getElementById('memberId').value.trim();

            if (!apiBaseUrl) {
                Swal.fire('éŒ¯èª¤', 'è«‹è¼¸å…¥ API åŸºç¤ URL', 'error');
                return;
            }

            if (!memberId) {
                Swal.fire('éŒ¯èª¤', 'è«‹è¼¸å…¥æœƒå“¡ ID', 'error');
                return;
            }

            updateConnectionStatus('å¿«é€Ÿæª¢æŸ¥ä¸­...', 'bg-warning');

            try {
                // ç›´æ¥ä½¿ç”¨ç°½åˆ°æŸ¥è©¢ç«¯é»æ¸¬è©¦é€£ç·š
                const response = await axios.get(`${apiBaseUrl}/api/Members/${memberId}/Checkin/Info`, {
                    timeout: 3000
                });

                updateConnectionStatus('å·²é€£ç·š', 'bg-success');
                Swal.fire({
                    title: 'é€£ç·šæˆåŠŸï¼',
                    html: `
                        <div class="text-start">
                            <p><strong>ä¼ºæœå™¨ç‹€æ…‹:</strong> æ­£å¸¸</p>
                            <p><strong>API ç«¯é»:</strong> å¯ç”¨</p>
                            <p><strong>æœƒå“¡ç‹€æ…‹:</strong> ${response.data.signedToday ? 'ä»Šæ—¥å·²ç°½åˆ°' : 'ä»Šæ—¥å°šæœªç°½åˆ°'}</p>
                            <p><strong>é€£çºŒå¤©æ•¸:</strong> ${response.data.checkinStreak} å¤©</p>
                        </div>
                    `,
                    icon: 'success'
                });

            } catch (error) {
                if (error.response?.status >= 400 && error.response?.status < 500) {
                    // 4xx éŒ¯èª¤è¡¨ç¤ºä¼ºæœå™¨æœ‰å›æ‡‰
                    updateConnectionStatus('å·²é€£ç·š', 'bg-success');
                    Swal.fire({
                        title: 'é€£ç·šæˆåŠŸ',
                        text: `ä¼ºæœå™¨å¯é€£ç·šï¼ˆHTTP ${error.response.status}ï¼‰`,
                        icon: 'info'
                    });
                } else if (error.code === 'ECONNABORTED') {
                    updateConnectionStatus('é€£ç·šå¤±æ•—', 'bg-danger');
                    Swal.fire('éŒ¯èª¤', 'é€£ç·šè¶…æ™‚ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–ä¼ºæœå™¨ç‹€æ…‹', 'error');
                } else {
                    updateConnectionStatus('é€£ç·šå¤±æ•—', 'bg-danger');
                    Swal.fire('éŒ¯èª¤', `é€£ç·šå¤±æ•—: ${error.message}`, 'error');
                }
                logError('å¿«é€Ÿé€£ç·šæª¢æŸ¥å¤±æ•—', error);
            }
        }

        // é‡ç½®ç°½åˆ°ç‹€æ…‹ï¼ˆæ¸…é™¤ä»Šæ—¥ç°½åˆ°è¨˜éŒ„ï¼‰
        async function resetCheckinStatus() {
            const memberId = document.getElementById('memberId').value.trim();
            const apiBaseUrl = document.getElementById('apiBaseUrl').value.trim();

            if (!memberId || !apiBaseUrl) {
                Swal.fire('éŒ¯èª¤', 'è«‹å¡«å…¥æœƒå“¡ ID å’Œ API URL', 'error');
                return;
            }

            // ç¢ºèªæ“ä½œ
            const confirmResult = await Swal.fire({
                title: 'ç¢ºèªé‡ç½®',
                text: 'é€™å°‡æ¸…é™¤ä»Šæ—¥çš„ç°½åˆ°è¨˜éŒ„ï¼Œè®“æ‚¨å¯ä»¥é‡æ–°æ¸¬è©¦ç°½åˆ°åŠŸèƒ½',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'ç¢ºå®šé‡ç½®',
                cancelButtonText: 'å–æ¶ˆ'
            });

            if (!confirmResult.isConfirmed) return;

            try {
                // é€™éœ€è¦å¾Œç«¯æä¾›æ¸…é™¤ä»Šæ—¥ç°½åˆ°è¨˜éŒ„çš„ API
                // å¦‚æœæ²’æœ‰ï¼Œæˆ‘å€‘å¯ä»¥ç›´æ¥åˆªé™¤ localStorage ä¾†æ¨¡æ“¬

                // æ¸…é™¤ localStorage ä¸­çš„å¿«å–
                const today = new Date().toISOString().split('T')[0];
                localStorage.removeItem(`checkin:lastDate:${memberId}`);
                localStorage.removeItem(`checkin:streak:${memberId}`);
                localStorage.removeItem(`checkin:reward:${memberId}`);

                console.log('å·²æ¸…é™¤æœ¬åœ°ç°½åˆ°å¿«å–');

                Swal.fire({
                    title: 'é‡ç½®å®Œæˆ',
                    html: `
                        <div class="text-start">
                            <p>ğŸ“ å·²æ¸…é™¤æœ¬åœ°ç°½åˆ°å¿«å–</p>
                            <p>ğŸ”„ è«‹é‡æ–°æŸ¥è©¢ç°½åˆ°ç‹€æ…‹</p>
                            <p class="text-warning small">æ³¨æ„ï¼šé€™åªæ¸…é™¤æœ¬åœ°å¿«å–ï¼Œå¾Œç«¯è³‡æ–™éœ€è¦æ‰‹å‹•æ¸…é™¤</p>
                        </div>
                    `,
                    icon: 'success'
                });

                // è‡ªå‹•é‡æ–°æŸ¥è©¢ç‹€æ…‹
                setTimeout(() => {
                    getCheckinInfo();
                }, 1000);

            } catch (error) {
                console.error('é‡ç½®ç°½åˆ°ç‹€æ…‹å¤±æ•—:', error);
                Swal.fire('éŒ¯èª¤', `é‡ç½®å¤±æ•—: ${error.message}`, 'error');
            }
        }

        // æ¨¡æ“¬æ˜¨å¤©ç°½åˆ°ï¼ˆä¿®æ”¹ localStorage ä¾†æ¸¬è©¦é€£çºŒç°½åˆ°ï¼‰
        async function simulateYesterdayCheckin() {
            const memberId = document.getElementById('memberId').value.trim();

            if (!memberId) {
                Swal.fire('éŒ¯èª¤', 'è«‹å¡«å…¥æœƒå“¡ ID', 'error');
                return;
            }

            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayStr = yesterday.toISOString().split('T')[0];

            // è¨­å®šæ˜¨å¤©çš„ç°½åˆ°è¨˜éŒ„
            localStorage.setItem(`checkin:lastDate:${memberId}`, yesterdayStr);
            localStorage.setItem(`checkin:streak:${memberId}`, '1');
            localStorage.setItem(`checkin:reward:${memberId}`, '0.1');

            Swal.fire({
                title: 'æ¨¡æ“¬å®Œæˆ',
                html: `
                    <div class="text-start">
                        <p>ğŸ“… å·²è¨­å®šæ˜¨å¤© (${yesterdayStr}) ç°½åˆ°è¨˜éŒ„</p>
                        <p>ğŸ”¥ é€£çºŒç°½åˆ°å¤©æ•¸ï¼š1 å¤©</p>
                        <p>ğŸ’° æ˜¨æ—¥ç²å¾—ï¼š0.1 Jå¹£</p>
                        <p class="text-info small mt-2">ç¾åœ¨åŸ·è¡Œç°½åˆ°æ‡‰è©²æœƒé¡¯ç¤ºé€£çºŒç¬¬ 2 å¤©</p>
                    </div>
                `,
                icon: 'success'
            });

            // è‡ªå‹•é‡æ–°æŸ¥è©¢ç‹€æ…‹
            setTimeout(() => {
                getCheckinInfo();
            }, 1000);
        }

        // æ¨¡æ“¬é€£çºŒç°½åˆ°æ¸¬è©¦
        async function simulateStreakCheckin() {
            const memberId = document.getElementById('memberId').value.trim();

            if (!memberId) {
                Swal.fire('éŒ¯èª¤', 'è«‹å¡«å…¥æœƒå“¡ ID', 'error');
                return;
            }

            // è®“ç”¨æˆ¶é¸æ“‡è¦æ¨¡æ“¬çš„é€£çºŒå¤©æ•¸
            const { value: streakDays } = await Swal.fire({
                title: 'è¨­å®šé€£çºŒç°½åˆ°å¤©æ•¸',
                input: 'number',
                inputLabel: 'è«‹è¼¸å…¥è¦æ¨¡æ“¬çš„é€£çºŒç°½åˆ°å¤©æ•¸ (1-30)',
                inputValue: 5,
                inputAttributes: {
                    min: 1,
                    max: 30,
                    step: 1
                },
                showCancelButton: true,
                confirmButtonText: 'è¨­å®š',
                cancelButtonText: 'å–æ¶ˆ'
            });

            if (!streakDays || streakDays < 1 || streakDays > 30) return;

            // è¨ˆç®—å‰ä¸€å¤©çš„æ—¥æœŸ
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayStr = yesterday.toISOString().split('T')[0];

            // è¨ˆç®—é æœŸçå‹µï¼ˆ7å¤©å¾ªç’°ï¼‰
            const dayInCycle = ((streakDays - 1) % 7) + 1;
            const expectedReward = dayInCycle * 0.1;

            // è¨­å®šæ¨¡æ“¬è³‡æ–™
            localStorage.setItem(`checkin:lastDate:${memberId}`, yesterdayStr);
            localStorage.setItem(`checkin:streak:${memberId}`, streakDays.toString());
            localStorage.setItem(`checkin:reward:${memberId}`, expectedReward.toString());

            Swal.fire({
                title: 'é€£çºŒç°½åˆ°æ¨¡æ“¬å®Œæˆ',
                html: `
                    <div class="text-start">
                        <p>ğŸ“… ä¸Šæ¬¡ç°½åˆ°ï¼š${yesterdayStr}</p>
                        <p>ğŸ”¥ é€£çºŒç°½åˆ°ï¼š${streakDays} å¤©</p>
                        <p>ğŸ’° é æœŸä»Šæ—¥çå‹µï¼š${((streakDays % 7) + 1) * 0.1} Jå¹£</p>
                        <p class="text-info small mt-2">ç¾åœ¨åŸ·è¡Œç°½åˆ°æ‡‰è©²æœƒé¡¯ç¤ºé€£çºŒç¬¬ ${parseInt(streakDays) + 1} å¤©</p>
                    </div>
                `,
                icon: 'success'
            });

            // è‡ªå‹•é‡æ–°æŸ¥è©¢ç‹€æ…‹
            setTimeout(() => {
                getCheckinInfo();
            }, 1000);
        }

        // æŸ¥è©¢ç°½åˆ°ç‹€æ…‹
        async function getCheckinInfo() {
            const memberId = document.getElementById('memberId').value.trim();
            const apiBaseUrl = document.getElementById('apiBaseUrl').value.trim();

            if (!memberId || !apiBaseUrl) {
                Swal.fire('éŒ¯èª¤', 'è«‹å¡«å…¥æœƒå“¡ ID å’Œ API URL', 'error');
                return;
            }

            try {
                const url = `${apiBaseUrl}/api/Members/${memberId}/Checkin/Info`;
                console.log('æŸ¥è©¢ç°½åˆ°ç‹€æ…‹ URL:', url);

                const response = await axios.get(url, {
                    timeout: 10000,
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = {
                    success: true,
                    url: url,
                    status: response.status,
                    data: response.data,
                    timestamp: new Date().toLocaleString()
                };

                document.getElementById('statusResult').textContent = JSON.stringify(result, null, 2);

                // å±•é–‹çµæœ
                const statusCollapse = new bootstrap.Collapse(document.getElementById('statusCollapse'), {
                    show: true
                });

                Swal.fire({
                    title: 'æŸ¥è©¢æˆåŠŸ',
                    html: `
                        <div class="text-start">
                            <p><strong>æœƒå“¡ ID:</strong> ${response.data.memberId}</p>
                            <p><strong>ä»Šæ—¥æ—¥æœŸ:</strong> ${response.data.today}</p>
                            <p><strong>ä»Šæ—¥å·²ç°½åˆ°:</strong> ${response.data.signedToday ? 'æ˜¯' : 'å¦'}</p>
                            <p><strong>é€£çºŒç°½åˆ°å¤©æ•¸:</strong> ${response.data.checkinStreak}</p>
                            <p><strong>ä»Šæ—¥çå‹µ:</strong> ${response.data.todayReward} ${response.data.unit}</p>
                            <p><strong>ä¼ºæœå™¨æ™‚é–“:</strong> ${response.data.serverTime}</p>
                        </div>
                    `,
                    icon: 'success'
                });

            } catch (error) {
                const errorResult = {
                    success: false,
                    url: `${apiBaseUrl}/api/Members/${memberId}/Checkin/Info`,
                    error: error.message,
                    status: error.response?.status,
                    data: error.response?.data,
                    timestamp: new Date().toLocaleString()
                };

                document.getElementById('statusResult').textContent = JSON.stringify(errorResult, null, 2);
                logError('æŸ¥è©¢ç°½åˆ°ç‹€æ…‹å¤±æ•—', error);

                Swal.fire('éŒ¯èª¤', `æŸ¥è©¢å¤±æ•—: ${error.message}`, 'error');
            }
        }

        // åŸ·è¡Œç°½åˆ°
        async function performCheckin() {
            const memberId = document.getElementById('memberId').value.trim();
            const apiBaseUrl = document.getElementById('apiBaseUrl').value.trim();

            if (!memberId || !apiBaseUrl) {
                Swal.fire('éŒ¯èª¤', 'è«‹å¡«å…¥æœƒå“¡ ID å’Œ API URL', 'error');
                return;
            }

            try {
                const url = `${apiBaseUrl}/api/Members/${memberId}/Checkin`;
                console.log('åŸ·è¡Œç°½åˆ° URL:', url);

                const response = await axios.post(url, {}, {
                    timeout: 10000,
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = {
                    success: true,
                    url: url,
                    status: response.status,
                    data: response.data,
                    timestamp: new Date().toLocaleString()
                };

                document.getElementById('checkinResult').textContent = JSON.stringify(result, null, 2);

                // å±•é–‹çµæœ
                const checkinCollapse = new bootstrap.Collapse(document.getElementById('checkinCollapse'), {
                    show: true
                });

                Swal.fire({
                    title: 'ç°½åˆ°æˆåŠŸï¼',
                    html: `
                        <div class="text-start">
                            <p><strong>ç²å¾—çå‹µ:</strong> ${response.data.reward} Jå¹£</p>
                            <p><strong>ç°½åˆ°å‰é¤˜é¡:</strong> ${response.data.beforeBalance}</p>
                            <p><strong>ç°½åˆ°å¾Œé¤˜é¡:</strong> ${response.data.afterBalance}</p>
                            <p><strong>é€£çºŒç°½åˆ°å¤©æ•¸:</strong> ${response.data.checkinStreak}</p>
                            <p><strong>é©—è­‰ç¢¼:</strong> ${response.data.verificationCode}</p>
                        </div>
                    `,
                    icon: 'success'
                });

            } catch (error) {
                const errorResult = {
                    success: false,
                    url: `${apiBaseUrl}/api/Members/${memberId}/Checkin`,
                    error: error.message,
                    status: error.response?.status,
                    data: error.response?.data,
                    timestamp: new Date().toLocaleString()
                };

                document.getElementById('checkinResult').textContent = JSON.stringify(errorResult, null, 2);
                logError('åŸ·è¡Œç°½åˆ°å¤±æ•—', error);

                if (error.response?.status === 400) {
                    Swal.fire('æç¤º', 'å¯èƒ½ä»Šæ—¥å·²ç¶“ç°½åˆ°éäº†', 'info');
                } else {
                    Swal.fire('éŒ¯èª¤', `ç°½åˆ°å¤±æ•—: ${error.message}`, 'error');
                }
            }
        }

        // è¨˜éŒ„éŒ¯èª¤
        function logError(message, error) {
            const errorLog = document.getElementById('errorLog');
            const timestamp = new Date().toLocaleString();
            const errorText = `[${timestamp}] ${message}\n${error.stack || error.message}\n\n`;

            if (errorLog.textContent === 'ç„¡éŒ¯èª¤') {
                errorLog.textContent = errorText;
            } else {
                errorLog.textContent += errorText;
            }
        }

        // æ¸…é™¤çµæœ
        function clearResults() {
            document.getElementById('statusResult').textContent = 'å°šæœªæŸ¥è©¢';
            document.getElementById('checkinResult').textContent = 'å°šæœªåŸ·è¡Œ';
            document.getElementById('errorLog').textContent = 'ç„¡éŒ¯èª¤';
            updateConnectionStatus('æœªæ¸¬è©¦', 'bg-secondary');
        }

        // é é¢è¼‰å…¥æ™‚çš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function () {
            // å˜—è©¦å¾ localStorage ç²å–ä¹‹å‰çš„è¨­å®š
            const savedApiUrl = localStorage.getItem('testApiUrl');
            const savedMemberId = localStorage.getItem('testMemberId');

            if (savedApiUrl) {
                document.getElementById('apiBaseUrl').value = savedApiUrl;
            }

            if (savedMemberId) {
                document.getElementById('memberId').value = savedMemberId;
            }

            // ç›£è½è¼¸å…¥è®ŠåŒ–ï¼Œè‡ªå‹•ä¿å­˜è¨­å®š
            document.getElementById('apiBaseUrl').addEventListener('input', function () {
                localStorage.setItem('testApiUrl', this.value);
            });

            document.getElementById('memberId').addEventListener('input', function () {
                localStorage.setItem('testMemberId', this.value);
            });
        });
    </script>
</body>

</html>