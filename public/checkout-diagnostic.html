<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çµå¸³å•é¡Œè¨ºæ–·å·¥å…·</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .status-pass { color: #28a745; }
        .status-fail { color: #dc3545; }
        .status-warning { color: #ffc107; }
        .code-block { background: #f8f9fa; padding: 1rem; border-radius: 0.25rem; margin: 0.5rem 0; }
        .test-result { margin: 1rem 0; padding: 1rem; border-radius: 0.5rem; }
        .test-pass { background: #d4edda; border: 1px solid #c3e6cb; }
        .test-fail { background: #f8d7da; border: 1px solid #f5c6cb; }
        .test-warning { background: #fff3cd; border: 1px solid #ffeaa7; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="mb-4">ğŸ›’ çµå¸³å•é¡Œè¨ºæ–·å·¥å…·</h1>
        
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h3>ğŸ” çµå¸³æµç¨‹æª¢æŸ¥</h3>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-primary mb-3" onclick="runCheckoutDiagnosis()">é–‹å§‹æª¢æŸ¥çµå¸³å•é¡Œ</button>
                        <div id="checkoutResults"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h4>ğŸ›’ è³¼ç‰©è»Šç‹€æ…‹</h4>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-info" onclick="checkCartStatus()">æª¢æŸ¥è³¼ç‰©è»Š</button>
                        <div id="cartStatus" class="mt-3"></div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h4>ğŸ” ç™»å…¥ç‹€æ…‹</h4>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-success" onclick="checkLoginForCheckout()">æª¢æŸ¥ç™»å…¥</button>
                        <div id="loginForCheckout" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h4>ğŸ§ª æ¨¡æ“¬çµå¸³æµç¨‹</h4>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-warning" onclick="simulateCheckout()">æ¨¡æ“¬é»æ“Šçµå¸³æŒ‰éˆ•</button>
                        <div id="checkoutSimulation" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h4>ğŸ”§ ä¿®å¾©å»ºè­°</h4>
                    </div>
                    <div class="card-body" id="suggestions">
                        <p>é»æ“Šä¸Šæ–¹æ¸¬è©¦æŒ‰éˆ•é–‹å§‹è¨ºæ–·...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        const API_BASE_URL = 'https://jadeapi-production.up.railway.app';
        
        function log(message, type = 'info') {
            console.log(`[CHECKOUT-DIAGNOSTIC] ${message}`);
        }

        function addResult(containerId, title, status, message, details = '') {
            const container = document.getElementById(containerId);
            const statusClass = status === 'pass' ? 'test-pass' : status === 'fail' ? 'test-fail' : 'test-warning';
            const statusIcon = status === 'pass' ? 'âœ…' : status === 'fail' ? 'âŒ' : 'âš ï¸';
            
            const resultHtml = `
                <div class="test-result ${statusClass}">
                    <h6>${statusIcon} ${title}</h6>
                    <p>${message}</p>
                    ${details ? `<div class="code-block">${details}</div>` : ''}
                </div>
            `;
            
            container.innerHTML += resultHtml;
        }

        function checkCartStatus() {
            const cartDiv = document.getElementById('cartStatus');
            cartDiv.innerHTML = '<p>ğŸ”„ æª¢æŸ¥è³¼ç‰©è»Šç‹€æ…‹...</p>';
            
            // æª¢æŸ¥ localStorage ä¸­çš„è³¼ç‰©è»Šè³‡æ–™
            const cartItems = localStorage.getItem('cartItems');
            const cartData = cartItems ? JSON.parse(cartItems) : [];
            
            // æª¢æŸ¥ sessionStorage
            const sessionCart = sessionStorage.getItem('cartItems');
            const sessionCartData = sessionCart ? JSON.parse(sessionCart) : [];
            
            let statusHtml = '<h6>è³¼ç‰©è»Šè³‡æ–™æª¢æŸ¥ï¼š</h6>';
            statusHtml += `<p><strong>localStorage è³¼ç‰©è»Š:</strong> ${cartData.length} é …å•†å“</p>`;
            statusHtml += `<p><strong>sessionStorage è³¼ç‰©è»Š:</strong> ${sessionCartData.length} é …å•†å“</p>`;
            
            if (cartData.length > 0) {
                statusHtml += `<div class="code-block"><strong>localStorage è³¼ç‰©è»Šå…§å®¹:</strong><br><pre>${JSON.stringify(cartData, null, 2)}</pre></div>`;
            }
            
            if (sessionCartData.length > 0) {
                statusHtml += `<div class="code-block"><strong>sessionStorage è³¼ç‰©è»Šå…§å®¹:</strong><br><pre>${JSON.stringify(sessionCartData, null, 2)}</pre></div>`;
            }
            
            // æª¢æŸ¥ Vuex store (å¦‚æœå¯ç”¨)
            if (window.Vue && window.Vue.store) {
                const storeCart = window.Vue.store.state.cart || {};
                statusHtml += `<p><strong>Vuex Store è³¼ç‰©è»Š:</strong> ${storeCart.items ? storeCart.items.length : 0} é …å•†å“</p>`;
            }
            
            cartDiv.innerHTML = statusHtml;
            
            return {
                localStorageItems: cartData.length,
                sessionStorageItems: sessionCartData.length,
                hasItems: cartData.length > 0 || sessionCartData.length > 0
            };
        }

        function checkLoginForCheckout() {
            const loginDiv = document.getElementById('loginForCheckout');
            loginDiv.innerHTML = '<p>ğŸ”„ æª¢æŸ¥ç™»å…¥ç‹€æ…‹...</p>';
            
            // æª¢æŸ¥æ‰€æœ‰å¯èƒ½çš„ç™»å…¥ç‹€æ…‹å„²å­˜ä½ç½®
            const memberId = localStorage.getItem('memberId');
            const authToken = localStorage.getItem('authToken') || localStorage.getItem('token');
            const currentUser = localStorage.getItem('currentUser');
            const isLoggedIn = localStorage.getItem('isLoggedIn');
            
            // æª¢æŸ¥ sessionStorage
            const sessionMemberId = sessionStorage.getItem('memberId');
            const sessionToken = sessionStorage.getItem('authToken') || sessionStorage.getItem('token');
            
            let statusHtml = '<h6>ç™»å…¥è³‡æ–™æª¢æŸ¥ï¼š</h6>';
            statusHtml += `<p><strong>localStorage memberId:</strong> ${memberId || 'âŒ æœªæ‰¾åˆ°'}</p>`;
            statusHtml += `<p><strong>localStorage authToken:</strong> ${authToken ? 'âœ… å·²è¨­å®š' : 'âŒ æœªæ‰¾åˆ°'}</p>`;
            statusHtml += `<p><strong>localStorage currentUser:</strong> ${currentUser ? 'âœ… å·²è¨­å®š' : 'âŒ æœªæ‰¾åˆ°'}</p>`;
            statusHtml += `<p><strong>localStorage isLoggedIn:</strong> ${isLoggedIn || 'âŒ æœªè¨­å®š'}</p>`;
            statusHtml += `<p><strong>sessionStorage memberId:</strong> ${sessionMemberId || 'âŒ æœªæ‰¾åˆ°'}</p>`;
            statusHtml += `<p><strong>sessionStorage authToken:</strong> ${sessionToken ? 'âœ… å·²è¨­å®š' : 'âŒ æœªæ‰¾åˆ°'}</p>`;
            
            if (currentUser) {
                try {
                    const user = JSON.parse(currentUser);
                    statusHtml += `<div class="code-block"><strong>ç”¨æˆ¶è³‡æ–™:</strong><br><pre>${JSON.stringify(user, null, 2)}</pre></div>`;
                } catch (e) {
                    statusHtml += `<p class="status-fail">ç”¨æˆ¶è³‡æ–™æ ¼å¼éŒ¯èª¤: ${e.message}</p>`;
                }
            }
            
            loginDiv.innerHTML = statusHtml;
            
            return {
                hasLocalMemberId: !!memberId,
                hasLocalToken: !!authToken,
                hasSessionMemberId: !!sessionMemberId,
                hasSessionToken: !!sessionToken,
                isLoggedIn: !!(memberId && authToken) || !!(sessionMemberId && sessionToken)
            };
        }

        function simulateCheckout() {
            const simulationDiv = document.getElementById('checkoutSimulation');
            simulationDiv.innerHTML = '<p>ğŸ”„ æ¨¡æ“¬çµå¸³æµç¨‹...</p>';
            
            // æª¢æŸ¥è³¼ç‰©è»Šç‹€æ…‹
            const cartStatus = checkCartStatus();
            const loginStatus = checkLoginForCheckout();
            
            let simulationHtml = '<h6>æ¨¡æ“¬çµå¸³æª¢æŸ¥ï¼š</h6>';
            
            // æ­¥é©Ÿ 1: æª¢æŸ¥è³¼ç‰©è»Šæ˜¯å¦ç‚ºç©º
            if (!cartStatus.hasItems) {
                simulationHtml += `
                    <div class="alert alert-danger">
                        <strong>âŒ æ­¥é©Ÿ 1 å¤±æ•—:</strong> è³¼ç‰©è»Šæ˜¯ç©ºçš„
                        <br>é€™æœƒå°è‡´çµå¸³æŒ‰éˆ•é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯è€Œä¸è·³è½‰
                    </div>
                `;
            } else {
                simulationHtml += `
                    <div class="alert alert-success">
                        <strong>âœ… æ­¥é©Ÿ 1 é€šé:</strong> è³¼ç‰©è»Šæœ‰ ${cartStatus.localStorageItems + cartStatus.sessionStorageItems} é …å•†å“
                    </div>
                `;
            }
            
            // æ­¥é©Ÿ 2: æª¢æŸ¥è·¯ç”±
            simulationHtml += `
                <div class="alert alert-info">
                    <strong>ğŸ“ æ­¥é©Ÿ 2:</strong> æª¢æŸ¥è·¯ç”±è·³è½‰
                    <br>ç•¶å‰ URL: ${window.location.href}
                    <br>é æœŸè·³è½‰åˆ°: ${window.location.origin}/checkout
                </div>
            `;
            
            // æ­¥é©Ÿ 3: æ¨¡æ“¬è·³è½‰
            if (cartStatus.hasItems) {
                simulationHtml += `
                    <div class="alert alert-warning">
                        <strong>âš ï¸ æ­¥é©Ÿ 3:</strong> æº–å‚™æ¸¬è©¦è·³è½‰
                        <br><button class="btn btn-sm btn-primary mt-2" onclick="testCheckoutRedirect()">æ¸¬è©¦è·³è½‰åˆ°çµå¸³é é¢</button>
                    </div>
                `;
            }
            
            simulationDiv.innerHTML = simulationHtml;
        }

        function testCheckoutRedirect() {
            log('Testing checkout redirect');
            
            // å…ˆæª¢æŸ¥çµå¸³é é¢æ˜¯å¦å­˜åœ¨
            fetch('/checkout')
                .then(response => {
                    if (response.ok) {
                        // é é¢å­˜åœ¨ï¼Œå˜—è©¦è·³è½‰
                        window.location.href = '/checkout';
                    } else {
                        alert('âŒ çµå¸³é é¢ä¸å­˜åœ¨æˆ–æœ‰å•é¡Œ (HTTP ' + response.status + ')');
                    }
                })
                .catch(error => {
                    console.error('Error testing checkout page:', error);
                    // å³ä½¿æª¢æŸ¥å¤±æ•—ï¼Œä¹Ÿå˜—è©¦è·³è½‰
                    window.location.href = '/checkout';
                });
        }

        async function runCheckoutDiagnosis() {
            const resultsDiv = document.getElementById('checkoutResults');
            resultsDiv.innerHTML = '<h5>ğŸ”„ åŸ·è¡Œçµå¸³è¨ºæ–·...</h5>';
            
            // è¨ºæ–· 1: è³¼ç‰©è»Šç‹€æ…‹
            const cartStatus = checkCartStatus();
            if (cartStatus.hasItems) {
                addResult('checkoutResults', 'è³¼ç‰©è»Šç‹€æ…‹', 'pass', `è³¼ç‰©è»Šæœ‰å•†å“ (å…± ${cartStatus.localStorageItems + cartStatus.sessionStorageItems} é …)`);
            } else {
                addResult('checkoutResults', 'è³¼ç‰©è»Šç‹€æ…‹', 'fail', 'è³¼ç‰©è»Šæ˜¯ç©ºçš„ï¼Œé€™æ˜¯ç„¡æ³•é€²å…¥çµå¸³çš„ä¸»è¦åŸå› ');
            }
            
            // è¨ºæ–· 2: ç™»å…¥ç‹€æ…‹
            const loginStatus = checkLoginForCheckout();
            if (loginStatus.isLoggedIn) {
                addResult('checkoutResults', 'ç™»å…¥ç‹€æ…‹', 'pass', 'ç”¨æˆ¶å·²ç™»å…¥');
            } else {
                addResult('checkoutResults', 'ç™»å…¥ç‹€æ…‹', 'warning', 'ç”¨æˆ¶æœªç™»å…¥ï¼Œå¯èƒ½å½±éŸ¿çµå¸³æµç¨‹');
            }
            
            // è¨ºæ–· 3: è·¯ç”±æª¢æŸ¥
            try {
                const checkoutResponse = await fetch('/checkout');
                if (checkoutResponse.ok) {
                    addResult('checkoutResults', 'çµå¸³é é¢', 'pass', 'çµå¸³é é¢å¯æ­£å¸¸è¨ªå•');
                } else {
                    addResult('checkoutResults', 'çµå¸³é é¢', 'fail', `çµå¸³é é¢å›æ‡‰éŒ¯èª¤ (HTTP ${checkoutResponse.status})`);
                }
            } catch (error) {
                addResult('checkoutResults', 'çµå¸³é é¢', 'fail', `ç„¡æ³•è¨ªå•çµå¸³é é¢: ${error.message}`);
            }
            
            // ç”Ÿæˆå»ºè­°
            generateCheckoutSuggestions(cartStatus, loginStatus);
        }

        function generateCheckoutSuggestions(cartStatus, loginStatus) {
            const suggestionsDiv = document.getElementById('suggestions');
            
            let suggestions = '<h5>ğŸ”§ ä¿®å¾©å»ºè­°ï¼š</h5>';
            
            if (!cartStatus.hasItems) {
                suggestions += `
                    <div class="alert alert-danger">
                        <h6>â— ä¸»è¦å•é¡Œï¼šè³¼ç‰©è»Šç‚ºç©º</h6>
                        <p><strong>è§£æ±ºæ–¹æ¡ˆï¼š</strong></p>
                        <ul>
                            <li>å…ˆæ·»åŠ å•†å“åˆ°è³¼ç‰©è»Š</li>
                            <li>æª¢æŸ¥å•†å“æ·»åŠ åŠŸèƒ½æ˜¯å¦æ­£å¸¸</li>
                            <li>ç¢ºèªè³¼ç‰©è»Šè³‡æ–™æ˜¯å¦æ­£ç¢ºå„²å­˜</li>
                        </ul>
                        <button class="btn btn-sm btn-success" onclick="window.location.href='/'">å‰å¾€å•†å“é é¢</button>
                    </div>
                `;
            }
            
            if (!loginStatus.isLoggedIn) {
                suggestions += `
                    <div class="alert alert-warning">
                        <h6>âš ï¸ å»ºè­°ï¼šç™»å…¥å¸³è™Ÿ</h6>
                        <p>é›–ç„¶å¯èƒ½ä¸æ˜¯å¿…é ˆçš„ï¼Œä½†å»ºè­°å…ˆç™»å…¥ä»¥ç¢ºä¿çµå¸³æµç¨‹é †æš¢</p>
                        <button class="btn btn-sm btn-primary" onclick="window.location.href='/login'">å‰å¾€ç™»å…¥é é¢</button>
                    </div>
                `;
            }
            
            if (cartStatus.hasItems && loginStatus.isLoggedIn) {
                suggestions += `
                    <div class="alert alert-success">
                        <h6>âœ… ç‹€æ…‹è‰¯å¥½</h6>
                        <p>è³¼ç‰©è»Šå’Œç™»å…¥ç‹€æ…‹éƒ½æ­£å¸¸ï¼Œçµå¸³æ‡‰è©²å¯ä»¥æ­£å¸¸é€²è¡Œ</p>
                        <button class="btn btn-sm btn-warning" onclick="testCheckoutRedirect()">æ¸¬è©¦çµå¸³è·³è½‰</button>
                    </div>
                `;
            }
            
            suggestions += `
                <div class="alert alert-info">
                    <h6>ğŸ“ å…¶ä»–æª¢æŸ¥é …ç›®ï¼š</h6>
                    <ul>
                        <li>æª¢æŸ¥ç€è¦½å™¨æ§åˆ¶å°æ˜¯å¦æœ‰ JavaScript éŒ¯èª¤</li>
                        <li>æª¢æŸ¥ç¶²è·¯ç‹€æ…‹æ˜¯å¦æ­£å¸¸</li>
                        <li>å˜—è©¦é‡æ–°æ•´ç†é é¢</li>
                        <li>æ¸…é™¤ç€è¦½å™¨å¿«å–</li>
                    </ul>
                </div>
            `;
            
            suggestionsDiv.innerHTML = suggestions;
        }

        // é é¢è¼‰å…¥æ™‚è‡ªå‹•æª¢æŸ¥
        window.addEventListener('load', function() {
            log('Checkout diagnostic tool loaded');
            
            // è‡ªå‹•æª¢æŸ¥åŸºæœ¬ç‹€æ…‹
            setTimeout(() => {
                checkCartStatus();
                checkLoginForCheckout();
            }, 1000);
        });
    </script>
</body>
</html>
